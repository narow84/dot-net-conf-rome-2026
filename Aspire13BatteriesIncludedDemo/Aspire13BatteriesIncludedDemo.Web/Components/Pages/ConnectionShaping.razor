@page "/connection-shaping"
@attribute [StreamRendering]
@inject ConnectionShapingApiClient Client
@inject IDistributedCache DistributedCache

@using Microsoft.Extensions.Caching.Distributed
@using Aspire13BatteriesIncludedDemo.Web

<PageTitle>ğŸ”Œ Connection Shaping</PageTitle>

<h1>ğŸ”Œ Aspire Connection Shaping</h1>
<p class="lead">
    Come fa Aspire a passare le connection string ai progetti consumer?
    <strong>Environment Variables</strong> â€” nessuna modifica al codice, nessun <code>appsettings.json</code>,
    nessun User Secret. L'AppHost genera <code>ConnectionStrings__&lt;name&gt;</code> come env var,
    .NET Configuration la mappa automaticamente, e il client integration la legge e crea il tipo .NET giusto.
</p>

@if (shapingInfo is null)
{
    <p><em>Caricamento pipeline di connection shaping...</em></p>
}
else
{
    @* â”€â”€â”€â”€ ENV VAR MECHANISM â€” La sezione piÃ¹ importante â”€â”€â”€â”€ *@
    <div class="card mb-4 border-danger shadow">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">ğŸ¯ @shapingInfo.EnvVarMechanism.Title</h5>
        </div>
        <div class="card-body">
            <h6 class="text-danger fw-bold mb-3">Come funziona â€” step by step:</h6>
            <div class="list-group mb-3">
                @foreach (var step in shapingInfo.EnvVarMechanism.How)
                {
                    <div class="list-group-item list-group-item-action">
                        <code style="font-size:.95em;">@step</code>
                    </div>
                }
            </div>

            <h6 class="text-success fw-bold mb-2">PerchÃ© Ã¨ geniale:</h6>
            <ul class="mb-3">
                @foreach (var reason in shapingInfo.EnvVarMechanism.WhyThisIsBrilliant)
                {
                    <li>@reason</li>
                }
            </ul>

            <div class="alert alert-warning mb-0">
                <strong>ğŸ“˜ Convenzione .NET:</strong> @shapingInfo.EnvVarMechanism.DotNetConvention
            </div>
        </div>
    </div>

    @* â”€â”€â”€â”€ ENV VAR REALI iniettate in questo processo â”€â”€â”€â”€ *@
    @if (shapingInfo.InjectedEnvVars?.Length > 0)
    {
        <div class="card mb-4 border-warning shadow">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">ğŸ” Environment Variables REALI iniettate in questo processo (ApiService)</h5>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>ENV VAR (nel processo)</th>
                            <th>â†’</th>
                            <th>IConfiguration Key</th>
                            <th>Valore</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ev in shapingInfo.InjectedEnvVars)
                        {
                            <tr>
                                <td><code class="text-danger fw-bold">@ev.EnvVarName</code></td>
                                <td class="text-center">â†’</td>
                                <td><code class="text-primary">@ev.MapsToIConfiguration</code></td>
                                <td><code class="text-break" style="font-size:.8em;">@ev.Value</code></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">
                    âš ï¸ Queste env var sono generate automaticamente da Aspire quando fai <code>.WithReference()</code>.
                    Non devi scrivere nulla in <code>appsettings.json</code> â€” sono effimere, vivono solo nel processo.
                </small>
            </div>
        </div>
    }

    @* â”€â”€â”€â”€ Pipeline cards â”€â”€â”€â”€ *@
    <h3 class="mt-4 mb-3">ğŸ“Š Pipeline di Connection Shaping â€” 4 Shape dalla stessa infrastruttura</h3>

    var colorMap = new Dictionary<string, (string border, string bg, string icon)>
    {
        ["PostgreSQL"] = ("primary", "primary", "ğŸ˜"),
        ["Redis"]      = ("danger",  "danger",  "ğŸ”´")
    };

    @foreach (var shape in shapingInfo.Pipeline)
    {
        var key = shape.Resource.Contains("PostgreSQL") ? "PostgreSQL" : "Redis";
        var (border, bg, icon) = colorMap[key];

        <div class="card mb-4 border-@border">
            <div class="card-header bg-@bg text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">@icon @shape.Resource</h5>
                <span class="badge bg-light text-dark">@shape.Endpoint</span>
            </div>
            <div class="card-body p-0">

                @* â”€â”€ Step 1: AppHost definisce la risorsa â”€â”€ *@
                <div class="p-3 border-bottom" style="background:#f0f4ff;">
                    <div class="d-flex align-items-start">
                        <span class="badge bg-secondary me-2 mt-1" style="min-width:90px;">Step 1</span>
                        <div>
                            <strong>AppHost definisce la risorsa</strong>
                            <span class="text-muted ms-2">ğŸ“„ @shape.Step1File</span>
                            <pre class="mt-1 mb-0 p-2 bg-dark text-light rounded" style="font-size:.85em;">@shape.Step1AppHostResource</pre>
                        </div>
                    </div>
                </div>

                @* â”€â”€ Freccia con env var â”€â”€ *@
                <div class="text-center py-1" style="font-size:1.4em; color:#6c757d;">
                    â¬‡ï¸ <small class="text-danger fw-bold" style="font-size:.65em;">genera ENV VAR: <code>@shape.Step2EnvVarName</code></small>
                </div>

                @* â”€â”€ Step 2: WithReference() inietta la env var â”€â”€ *@
                <div class="p-3 border-bottom" style="background:#fff3cd;">
                    <div class="d-flex align-items-start">
                        <span class="badge bg-warning text-dark me-2 mt-1" style="min-width:90px;">Step 2</span>
                        <div>
                            <strong>WithReference() â€” genera ENV VAR, zero codice!</strong>
                            <span class="text-muted ms-2">ğŸ“„ AppHost.cs</span>
                            <pre class="mt-1 mb-1 p-2 bg-dark text-light rounded" style="font-size:.85em;">@shape.Step2AppHostReference</pre>
                            <div class="alert alert-danger py-1 px-2 mb-1 small">
                                <strong>ğŸ”‘ ENV VAR generata:</strong> <code class="text-break fw-bold">@shape.Step2EnvVarName = @shape.Step2InjectedValue</code>
                            </div>
                            <p class="mb-0 small">ğŸ“Œ @shape.Step2WhatHappens</p>
                        </div>
                    </div>
                </div>

                @* â”€â”€ Freccia con IConfiguration â”€â”€ *@
                <div class="text-center py-1" style="font-size:1.4em; color:#6c757d;">
                    â¬‡ï¸ <small class="text-success fw-bold" style="font-size:.65em;">IConfiguration legge automaticamente l'env var</small>
                </div>

                @* â”€â”€ Step 3: Il progetto sceglie il driver â”€â”€ *@
                <div class="p-3" style="background:#e8f5e9;">
                    <div class="d-flex align-items-start">
                        <span class="badge bg-success me-2 mt-1" style="min-width:90px;">Step 3 âœ¨</span>
                        <div>
                            <strong>Client Integration â€” crea il tipo .NET, il dev non fa nulla!</strong>
                            <span class="text-muted ms-2">ğŸ“„ @shape.Step3File</span>
                            <pre class="mt-1 mb-1 p-2 bg-dark text-warning rounded" style="font-size:.85em;">@shape.Step3ClientIntegration</pre>
                            <p class="mb-1 small">ğŸ“¦ <strong>NuGet:</strong> <code>@shape.Step3NuGetPackage</code></p>
                            <p class="mb-1 small">âš™ï¸ <strong>Cosa fa internamente:</strong> @shape.Step3WhatHappens</p>
                            <p class="mb-1 small">ğŸ·ï¸ <strong>Tipo nel DI:</strong> <code>@shape.Step3RegisteredType</code></p>
                            <p class="mb-0 small">ğŸ’‰ <strong>Usato come:</strong> <code>@shape.Step3UsedVia</code></p>
                        </div>
                    </div>
                </div>

                @* â”€â”€ Proof â”€â”€ *@
                <div class="p-2 border-top bg-light">
                    <small>ğŸ” <strong>Proof â€” connection string letta dal driver:</strong> <code class="text-break">@shape.ProofConnectionString</code></small>
                </div>

            </div>
        </div>
    }

    @* â”€â”€â”€â”€ Test live distributed cache â”€â”€â”€â”€ *@
    <div class="card mb-4 border-success">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">ğŸ§ª Test Live â€” IDistributedCache (Redis) nel Web Frontend</h5>
        </div>
        <div class="card-body">
            <p>
                Questa pagina Ã¨ nel <strong>Web frontend</strong>, che consuma la stessa risorsa Redis
                &ldquo;cache&rdquo; ma come <code>IDistributedCache</code>
                (tramite <code>builder.AddRedisDistributedCache("cache")</code>).
            </p>
            <p>
                <strong>Valore letto dalla cache:</strong>
                <code>@(cacheTestValue ?? "(vuoto â€” primo caricamento, ricarica la pagina!)")</code>
            </p>
            <p class="text-muted small mb-0">
                Anche qui: la connection string arriva come <code>ConnectionStrings__cache</code> env var.
                Nessun <code>appsettings.json</code>, nessun codice di configurazione.
            </p>
        </div>
    </div>

    @* â”€â”€â”€â”€ I 5 punti chiave â”€â”€â”€â”€ *@
    <div class="alert alert-info">
        <h5>ğŸ’¡ I 5 punti chiave â€” tutto ruota intorno alle ENV VAR</h5>
        <ol class="mb-0">
            <li class="fw-bold text-danger">@shapingInfo.KeyInsight.Punto1</li>
            <li class="fw-bold text-danger">@shapingInfo.KeyInsight.Punto2</li>
            <li>@shapingInfo.KeyInsight.Punto3</li>
            <li class="text-primary fw-bold">@shapingInfo.KeyInsight.Punto4</li>
            <li>@shapingInfo.KeyInsight.Punto5</li>
        </ol>
    </div>

    @* â”€â”€â”€â”€ Riepilogo visivo â”€â”€â”€â”€ *@
    <div class="card mb-4 border-dark">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">ğŸ“ Riepilogo: ENV VAR come ponte universale</h5>
        </div>
        <div class="card-body">
            <pre class="mb-0" style="font-size:.9em; line-height:1.6;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  <strong>AppHost.cs</strong>  (definisce le risorse infrastrutturali)                    â”‚
â”‚                                                                         â”‚
â”‚  AddPostgres("postgres").AddDatabase("appDb")    AddRedis("cache")     â”‚
â”‚       â”‚                                              â”‚                  â”‚
â”‚       â–¼                                              â–¼                  â”‚
â”‚  .WithReference(appDb)                       .WithReference(redis)     â”‚
â”‚       â”‚                                              â”‚                  â”‚
â”‚  genera ENV VAR:                              genera ENV VAR:           â”‚
â”‚  <strong class="text-danger">ConnectionStrings__appDb</strong>=Host=...          <strong class="text-danger">ConnectionStrings__cache</strong>=...  â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“Œ __ (doppio underscore) = separatore .NET per env var gerarchiche    â”‚
â”‚  ğŸ“Œ .NET Configuration mappa __ â†’ : automaticamente                     â”‚
â”‚  ğŸ“Œ ZERO appsettings.json â€¢ ZERO User Secrets â€¢ ZERO codice di config  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                              â”‚
        â–¼                                              â–¼
â”Œâ”€â”€â”€â”€ ApiService/Program.cs â”€â”€â”€â”   â”Œâ”€â”€â”€â”€ Web/Program.cs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               â”‚   â”‚                                   â”‚
â”‚  AddNpgsqlDataSource("appDb") â”‚   â”‚  AddRedisDistributedCache("cache")â”‚
â”‚  â†“ legge env var via          â”‚   â”‚  â†“ legge env var via              â”‚
â”‚    IConfiguration             â”‚   â”‚    IConfiguration                 â”‚
â”‚  â†’ NpgsqlDataSource           â”‚   â”‚  â†’ IDistributedCache              â”‚
â”‚                               â”‚   â”‚                                   â”‚
â”‚  AddNpgsqlDbContext("appDb")  â”‚   â”‚  Il codice NON cambia mai!        â”‚
â”‚  â†“ stessa env var!            â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â†’ CatalogDbContext           â”‚
â”‚                               â”‚
â”‚  AddRedisOutputCache("cache") â”‚
â”‚  â†“ env var cache              â”‚
â”‚  â†’ IOutputCacheStore          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ENV VAR + IConfiguration + Client Integration = ğŸª„ ZERO configurazione manuale
</pre>
        </div>
    </div>

    @* â”€â”€â”€â”€ Raw connection strings â”€â”€â”€â”€ *@
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">ğŸ“‹ Connection Strings â€” lette da IConfiguration (che legge le ENV VAR)</h5>
        </div>
        <div class="card-body">
            <dl class="mb-0">
                <dt><code>ConnectionStrings__appDb</code> â†’ <code>ConnectionStrings:appDb</code></dt>
                <dd><code class="text-break">@shapingInfo.RawConnectionStrings.AppDb</code></dd>
                <dt><code>ConnectionStrings__cache</code> â†’ <code>ConnectionStrings:cache</code></dt>
                <dd><code class="text-break">@shapingInfo.RawConnectionStrings.Cache</code></dd>
            </dl>
        </div>
    </div>
}

@code {
    private ConnectionShapingInfo? shapingInfo;
    private string? cacheTestValue;

    protected override async Task OnInitializedAsync()
    {
        // Read existing cache value (if any)
        var existing = await DistributedCache.GetStringAsync("connection-shaping-test");
        cacheTestValue = existing;

        // Write current timestamp to the distributed cache
        await DistributedCache.SetStringAsync(
            "connection-shaping-test",
            $"Scritto alle {DateTime.Now:HH:mm:ss} dal Web frontend",
            new DistributedCacheEntryOptions { AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(5) });

        // Fetch connection shaping info from the API
        try
        {
            shapingInfo = await Client.GetConnectionShapingAsync();
        }
        catch (Exception ex)
        {
            shapingInfo = new ConnectionShapingInfo(
                "Errore",
                new EnvVarMechanism("Errore", [], [], ""),
                [],
                [],
                new KeyInsight(ex.Message, "", "", "", ""),
                new RawConnectionStrings("N/A", "N/A"));
        }
    }
}
